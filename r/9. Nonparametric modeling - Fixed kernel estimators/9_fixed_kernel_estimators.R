# Encoding UTF-8

# ??? ???, ?????????????? ???????, ????? 2014
# Applied econometrics 9, nonparametric modeling, part 1. Fixed kernel estimators
# ????? ???????, 19.01.2015

# ??????? ??????
x <- seq(min(int), max(int), length=L)
L <- 10000
N <- length(int)
# ??? Gaussian ??????? ???????
f.fix <- npudens(tdat=int, edat=x, ckertype="gaussian", bwtype="fixed")

# ????????? ?????? ????? ??????? ??????? ??????? ? ?????-?????:
F.fix <- npudist(tdat=int, edat=x, ckertype="gaussian", bwtype="fixed")
alpha <- 0.01
a <- 1;	b <- L;	ab <- trunc((a + b)/2)
while ((b-a)>2) {
  if (F.fix$dist[ab] <= alpha) {
    a <- ab
  }
  if (F.fix$dist[ab] >= alpha) {
    b <- ab
  }
  ab <- trunc((a + b)/2)
}
q.fix <- x[ab]
# q.fix = -0.03540408			
M <- 10^6
y.fix.sim <- sample(x, prob=f.fix$dens, size=M, replace=TRUE)	
q.fix <- sort(y.fix.sim)[alpha*M]
# q.fix = -0.03628999		

# ????????	??????	VaR	??	??????	???????	???????:	
alpha <- 0.01
VaR1 <- numeric()
for (i in (T1+1):(T1+T2)) {
  h.int <- int[(i-h):(i-1)]
  F.fix <- npudist(tdat=h.int, edat=x, ckertype="gaussian", bwtype="fixed")
  a <- 1
  b <- L
  ab <- trunc((a + b)/2)
  while ((b-a) > 2) {
    if (F.fix$dist[ab] <= alpha) {
      a <- ab
    }
    if (F.fix$dist[ab] >= alpha) {
      b <- ab
    }
    ab <- trunc((a+b)/2)
  }
  VaR1[i-T1] <- x[ab]
}

# ?????? ???? ?????? ??? ??????? ?????? VaR:
K <- sum(fact < VaR1)
alpha0 <- K/T2
S <- -2*log((1-alpha)^(T2-K)*alpha^K)+ 2*log((1-alpha0)^(T2-K)*alpha0^K)
p.value <- 1 - pchisq(S, df=1)
# alpha0 = 0.01331361
# p.value = 0.4098843

# ????? ???????? ?????? VaR ?? ?????? ?????-?????:
for (i in (T1+1):(T1+T2)) {
  h.int <- int[(i-h):(i-1)]
  f.fix <- npudens(tdat=h.int, edat=x, kertype="gaussian", bwtype="fixed")
  y.fix.sim <- sample(x, prob=f.fix$dens, size=M, replace=TRUE)
  VaR[i-T1] <- sort(y.fix.sim)[alpha*M]
}
# alpha0 = 0.01183432
# p.value = 0.6413374

# ??????? ???????, ??????? ????? ?????????? ???????? ????????? ?????? 
# ?? ????????????? ????????????????? ??????, ????????? ????? ??????? ???????:
f1 <- function(y, x, alpha, L){
  F.fix <- npudist(tdat=y, edat=x, ckertype="gaussian", bwtype="fixed")
  a <- 1
  b <- L
  ab <- trunc((a + b)/2)
  while ((b-a)>2) {
  if (F.fix$dist[ab]<=alpha) a <- ab
  if (F.fix$dist[ab]>=alpha) b <- ab
  ab <- trunc((a + b)/2)
  }
  q.fix<- x[ab]
  print(q.fix)
}

# ?????	???????	???????	???	??????	?????-?????:
f <- function(y, x, alpha, M) {
  f.fix <- npudens(tdat=y, edat=x, kertype="gaussian", bwtype="fixed")
  y.fix.sim <- sample(x, prob=f.fix$dens, size=M, replace=TRUE)
  q.fix <- sort(y.fix.sim)[alpha*M]
  print(q.fix)
}

